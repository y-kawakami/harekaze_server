# Implementation Plan

- [x] 1. 全景バリデーションサービスの基盤構築
- [x] 1.1 全景バリデーション判定結果のデータクラスとレスポンススキーマを定義する
  - 判定結果（OK/NG）、判定理由（自然言語テキスト）、信頼度（0.0〜1.0）を保持する値オブジェクトを作成する
  - API レスポンス用の Pydantic スキーマを定義し、信頼度に値範囲バリデーション（0.0〜1.0）を設定する
  - _Requirements: 1.2, 1.3, 1.4_

- [x] 1.2 全景バリデーションサービスを実装する
  - AWS Bedrock Converse API を使用して画像が桜の全景として適切かを判定するサービスを作成する
  - aioboto3 の非同期クライアントパターン（既存の Rekognition クライアントと同一パターン）で Bedrock Runtime に接続する
  - 使用モデル ID を環境変数で設定可能にし、デフォルトは APAC クロスリージョン推論プロファイルとする
  - NG 判定条件（枝先端のみ、寄りすぎ、はみ出し）と OK 判定条件（幹から樹冠まで全体が確認可能）をプロンプトに定義する
  - toolConfig でツール定義スキーマを指定し、構造化 JSON で判定結果を受け取る
  - temperature を 0.0 に設定し判定の再現性を最大化する
  - Bedrock API エラー時はフェイルオープン（OK として扱い、confidence=0.0 でログ記録）する
  - レスポンスの JSON パース失敗時もフェイルオープンで処理する
  - シングルトンファクトリ関数を提供する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 6.1, 6.2, 6.3, 6.4_

- [x] 2. 例外クラスとデータモデルの定義
- [x] 2.1 (P) 全景バリデーション NG 判定時の例外クラスを定義する
  - 既存の例外基底クラスを継承し、NG 判定理由と信頼度を details に含める
  - ユニークなエラーコードとステータス 400 を設定する
  - _Requirements: 3.2, 3.3_

- [x] 2.2 (P) NG 判定ログを保存するためのデータベースモデルを定義する
  - S3 画像キー、判定結果、判定理由、信頼度、使用モデル ID、作成日時を保持するテーブルを定義する
  - 判定結果と作成日時にインデックスを付与する
  - UID フィールドに UUID を自動生成する
  - _Requirements: 運用要件_

- [x] 2.3 (P) NG 判定ログのリポジトリを実装する
  - 既存のリポジトリパターンに準拠し、ログレコードの作成機能を提供する
  - ファクトリ関数を提供し FastAPI の依存性注入で利用可能にする
  - _Requirements: 運用要件_

- [x] 3. 元気度判定パイプラインへの統合
- [x] 3.1 パイプラインに全景バリデーションを組み込む
  - Rekognition ラベル検出で木が確認された後、元気度解析の前に全景バリデーションを実行する
  - NG 判定時は画像を S3 に保存し（日付ベースのキーパターン）、判定結果を DB に記録してから例外を送出する
  - OK 判定時は後続の元気度解析・DB 登録を通常通り実行する
  - サービスとリポジトリは FastAPI の依存性注入で渡す
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 4. デバッグ API・ページの実装
- [x] 4.1 (P) 全景バリデーション専用デバッグ API エンドポイントを実装する
  - 画像ファイルを受け取り、全景バリデーションのみを実行して判定結果（OK/NG、理由、信頼度）を JSON で返却する
  - 元気度判定やその他の解析処理は実行しない
  - 既存のデバッグエンドポイントと同じ認証方式を使用する
  - デバッグ用アプリケーションロジックを作成し、サービス呼び出しと結果変換を行う
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 4.2 (P) 全景バリデーション専用 HTML デバッグページを実装する
  - GET でフォーム表示、POST で判定実行・結果表示の HTML ページを提供する
  - 既存のデバッグ HTML テンプレートと同一のスタイル・レイアウト（桜色テーマ、ローディングオーバーレイ）を踏襲する
  - OK/NG 判定、判定理由、信頼度を結果テーブルに表示する
  - _Requirements: 5.3_

- [x] 4.3 既存の元気度判定デバッグページに全景バリデーション結果を追加表示する
  - 元気度判定デバッグページの結果テーブルに全景バリデーションの OK/NG 判定、判定理由、信頼度の行を追加する
  - OK は緑色、NG は赤色で視覚的に区別する
  - 元気度判定デバッグのアプリケーションロジック内で全景バリデーションも実行し、レスポンススキーマに結果を含める
  - _Requirements: 5.1, 5.2_

- [x] 5. DB マイグレーションの作成
- [x] 5.1 全景バリデーションログテーブルの Alembic マイグレーションを作成する
  - タスク 2.2 で定義したデータベースモデルに基づきマイグレーションスクリプトを生成する
  - _Requirements: 運用要件_
