# Requirements Document

## Introduction

本仕様は、桜の元気度判定 API における「全景バリデーション」機能を定義する。現在の元気度判定パイプラインでは AWS Rekognition による `Tree` ラベル検出のみで画像の適格性を判定しているが、木の一部（枝先端のみ、幹のクローズアップなど）でも通過してしまう課題がある。本機能では AWS Bedrock のマルチモーダル LLM を活用し、桜の全景が適切に写っているかを判定する。判定結果には理由と信頼度を含め、不適切な画像を NG として拒否する。デバッグ用のテスト API と既存デバッグページへの機能追加も行う。

## Project Description (Input)
桜の元気度判定 API で、桜の全景が写っているもの以外は NG にしたい。
例えば、幹が写っておらず枝の先端だけのもの、幹や枝に寄りすぎて全体が写っていないもの、画像から枝や花など主な部位がはみ出ているものは NG にしたい。
判定には LLM(bedrock) のマルチモーダルモデル使って、判定した理由と信頼度も出したい。
デバッグ用に、この判定のみ行うテストAPIも作成する。既存の元気度判定のデバッグページにも試せるように機能追加したい。

## Requirements

### Requirement 1: 全景バリデーション判定ロジック
**Objective:** As a システム運用者, I want 桜の写真が全景として適切かどうかを LLM で自動判定したい, so that 一部分のみの写真や不適切な構図の画像が元気度判定に入力されることを防げる

#### Acceptance Criteria
1. When 画像が全景バリデーション API に送信された場合, the 全景バリデーションサービス shall AWS Bedrock のマルチモーダルモデルを使用して画像を解析し、桜の全景として適切かどうかを判定する
2. The 全景バリデーションサービス shall 判定結果として OK（全景として適切）または NG（不適切）のいずれかを返却する
3. The 全景バリデーションサービス shall 判定結果に加えて、判定理由を自然言語テキストとして返却する
4. The 全景バリデーションサービス shall 判定結果に加えて、信頼度を 0.0〜1.0 の数値で返却する

### Requirement 2: NG 判定条件の定義
**Objective:** As a システム運用者, I want 全景として不適切な画像パターンを明確に定義したい, so that 一貫した基準で画像の適格性を判断できる

#### Acceptance Criteria
1. When 幹が写っておらず枝の先端だけが写っている画像が送信された場合, the 全景バリデーションサービス shall NG と判定する
2. When 幹や枝に寄りすぎて木の全体像が写っていない画像が送信された場合, the 全景バリデーションサービス shall NG と判定する
3. When 枝や花など桜の主な部位が画像フレームからはみ出している画像が送信された場合, the 全景バリデーションサービス shall NG と判定する
4. When 桜の木全体（幹から樹冠まで）が概ね収まっている画像が送信された場合, the 全景バリデーションサービス shall OK と判定する

### Requirement 3: 元気度判定パイプラインへの統合
**Objective:** As a エンドユーザー, I want 全景として不適切な写真を投稿した場合に早期にフィードバックを受けたい, so that 適切な写真を撮り直して再投稿できる

#### Acceptance Criteria
1. When 元気度判定 API にて画像が投稿された場合, the 元気度判定パイプライン shall 既存の Rekognition ラベル検出の後かつ元気度解析の前に全景バリデーションを実行する
2. If 全景バリデーションで NG と判定された場合, the 元気度判定パイプライン shall 元気度解析を実行せずにエラーレスポンスを返却する
3. The エラーレスポンス shall NG 判定の理由と信頼度を含む

### Requirement 4: 全景バリデーション専用デバッグ API
**Objective:** As a 開発者, I want 全景バリデーションのみを単独で実行するテスト API がほしい, so that バリデーションロジックの精度を独立して検証・調整できる

#### Acceptance Criteria
1. When 画像ファイルが全景バリデーション専用デバッグ API に POST された場合, the デバッグ API shall 全景バリデーションのみを実行し、判定結果（OK/NG）、判定理由、信頼度を JSON で返却する
2. The 全景バリデーション専用デバッグ API shall 既存のデバッグエンドポイント群（`/debug/` プレフィックス）と同じ認証方式を使用する
3. The 全景バリデーション専用デバッグ API shall 元気度判定やその他の解析処理を実行しない

### Requirement 5: 既存デバッグページへの全景バリデーション機能追加
**Objective:** As a 開発者, I want 既存の元気度判定デバッグページで全景バリデーションも試したい, so that 元気度判定と全景バリデーションの結果を一画面で確認できる

#### Acceptance Criteria
1. When 既存の元気度判定デバッグページ（`/debug/analyze_tree_html`）で画像を送信した場合, the デバッグページ shall 元気度判定結果に加えて全景バリデーション結果も表示する
2. The デバッグページ shall 全景バリデーションの OK/NG 判定、判定理由、信頼度を既存の結果テーブルに追加表示する
3. The 全景バリデーション専用デバッグ API shall HTML フォーム付きのデバッグページ（GET でフォーム表示、POST で結果表示）も提供する

### Requirement 6: Bedrock マルチモーダルモデル連携
**Objective:** As a システム運用者, I want Bedrock のマルチモーダルモデルとの連携を安定して運用したい, so that 全景バリデーションが信頼性高く動作する

#### Acceptance Criteria
1. The 全景バリデーションサービス shall AWS Bedrock の Converse API またはInvokeModel API を使用してマルチモーダルモデルを呼び出す
2. If Bedrock API の呼び出しに失敗した場合, the 全景バリデーションサービス shall エラー情報をログに記録し、呼び出し元に適切なエラーを返却する
3. The 全景バリデーションサービス shall 使用するモデル ID を環境変数で設定可能とする
4. The 全景バリデーションサービス shall LLM へ送信するプロンプトを定義し、判定結果を構造化された形式（JSON）で受け取る
