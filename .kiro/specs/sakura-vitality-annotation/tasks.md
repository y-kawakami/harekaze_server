# Implementation Plan

## Tasks

- [x] 1. データベーススキーマとマイグレーション
- [x] 1.1 アノテーターテーブルの作成
  - アノテーターアカウント情報を格納するテーブルを作成
  - ユーザーIDはユニーク制約を設定
  - パスワードはbcryptでハッシュ化して保存
  - 最終ログイン日時を記録できる構造
  - _Requirements: 7.2_
- [x] 1.2 (P) 元気度アノテーションテーブルの作成
  - 桜画像ごとのアノテーション結果を格納するテーブルを作成
  - entire_tree_idにユニーク制約を設定（1画像1レコード）
  - 元気度値は1-5および-1（診断不可）を許容
  - アノテーション日時とアノテーターIDを記録
  - パフォーマンス向上のためのインデックス作成
  - _Requirements: 7.1, 7.5_
- [x] 1.3 初期アノテーターアカウントの投入
  - テスト・運用開始用の初期アノテーターアカウントを作成するマイグレーション
  - _Requirements: 7.2_

- [ ] 2. ドメイン層の実装
- [x] 2.1 (P) アノテーターモデルの定義
  - SQLAlchemy Mappedモデルでアノテーターエンティティを定義
  - 認証情報の永続化に必要なフィールドを実装
  - _Requirements: 7.2_
- [x] 2.2 (P) 元気度アノテーションモデルの定義
  - SQLAlchemy Mappedモデルでアノテーション結果エンティティを定義
  - entire_treesテーブルとのリレーション設定
  - _Requirements: 7.1, 7.5_
- [ ] 2.3 アノテーター認証サービスの実装
  - パスワード検証機能（bcrypt）
  - JWTトークン生成・検証機能
  - セッション有効期限管理（30日間）
  - 既存AuthServiceのパターンを踏襲
  - _Requirements: 1.1, 1.2, 1.4, 1.5_

- [ ] 3. アプリケーション層の実装
- [ ] 3.1 アノテーション一覧取得機能
  - entire_treesとvitality_annotationsのLEFT JOIN
  - タブフィルター（全て/入力済み/未入力）
  - 都道府県フィルター
  - 元気度フィルター（入力済み選択時のみ有効）
  - ページネーション
  - サムネイルURL生成
  - _Requirements: 2.1, 2.2, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_
- [ ] 3.2 統計情報取得機能
  - 全件数・入力済み件数・未入力件数の集計
  - 元気度別（1-5および-1）の件数集計
  - フィルター条件変更時の再計算
  - _Requirements: 2.3, 2.4_
- [ ] 3.3 アノテーション詳細取得機能
  - 署名付きURL生成による画像取得
  - 撮影情報（撮影日、都道府県、撮影場所）の取得
  - FloweringDateServiceを使った開花予想日情報の取得
  - 既存アノテーション値の取得
  - 現在位置（インデックス）と総件数の計算
  - 前後ナビゲーション用のID取得
  - _Requirements: 4.1, 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_
- [ ] 3.4 アノテーション保存機能
  - 元気度値のバリデーション（1-5または-1）
  - UPSERT処理（存在すれば更新、なければ挿入）
  - アノテーション日時・アノテーターID記録
  - _Requirements: 4.2, 4.3, 4.4, 4.5_
- [ ] 3.5 CSVエクスポート機能
  - アノテーション済みデータの取得
  - S3パス形式での出力（s3://hrkz-prd-s3-contents/sakura_camera/media/trees/{image_obj_key}）
  - 画像ファイル名の抽出
  - 診断不可（-1）データの包含
  - ストリーミングレスポンスでのCSV出力
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7_

- [ ] 4. インターフェース層の実装
- [ ] 4.1 認証APIエンドポイント
  - POST /annotation_api/login（ログイン・トークン発行）
  - GET /annotation_api/me（現在のアノテーター情報取得）
  - ログアウト処理（クライアント側トークン破棄）
  - 認証ミドルウェアの設定
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
- [ ] 4.2 アノテーションAPIエンドポイント
  - GET /annotation_api/trees（一覧取得・フィルタリング）
  - GET /annotation_api/trees/{entire_tree_id}（詳細取得）
  - POST /annotation_api/trees/{entire_tree_id}/annotation（アノテーション保存）
  - GET /annotation_api/prefectures（都道府県一覧）
  - GET /annotation_api/export/csv（CSVエクスポート）
  - 認証必須の設定
  - _Requirements: 2.1, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.4, 6.5, 9.1, 9.2_
- [ ] 4.3 (P) Pydanticスキーマ定義
  - リクエストスキーマ（AnnotationRequest等）
  - レスポンススキーマ（AnnotationListResponse, AnnotationDetailResponse等）
  - バリデーションロジック（元気度値の範囲チェック）
  - _Requirements: 4.2_

- [ ] 5. S3画像連携
- [ ] 5.1 アノテーション用画像URL生成
  - hrkz-prd-s3-contentsバケットからの画像取得
  - sakura_camera/media/trees/ + image_obj_key でのパス構成
  - 一覧用サムネイルURL生成
  - 詳細画面用署名付きURL生成
  - 画像取得失敗時のエラーハンドリング
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 6. フロントエンド実装
- [ ] 6.1 ログイン画面
  - ユーザーID・パスワード入力フォーム
  - ログインボタン
  - 認証エラーメッセージ表示
  - トークン保存処理
  - _Requirements: 1.1, 1.2_
- [ ] 6.2 一覧画面
  - 桜画像のサムネイル一覧表示
  - タブ切り替え（全て/入力済み/未入力）
  - 都道府県フィルター
  - 元気度フィルター（入力済み時のみ）
  - 該当件数・統計情報表示
  - ページネーション
  - CSVエクスポートボタン
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 9.1, 9.2_
- [ ] 6.3 アノテーション画面
  - 桜全体画像の表示
  - 元気度選択UI（6段階：とっても元気/元気/普通/少し気掛かり/気掛かり/診断不可）
  - 選択状態のハイライト表示
  - 撮影情報表示（撮影日、開花予想日、満開日、都道府県、撮影場所）
  - 現在の診断枚数（進捗）表示
  - 戻る・次へボタン
  - データ一覧リストへのリンク
  - 既存アノテーション値の初期表示
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_
- [ ] 6.4 ナビゲーション機能
  - 現在のフィルター条件を保持した前後遷移
  - 最初/最後の画像でのボタン無効化
  - アノテーション保存後の自動遷移
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
- [ ] 6.5 認証状態管理
  - ログイン状態の維持
  - セッション切れ時のログイン画面リダイレクト
  - ログアウト機能
  - _Requirements: 1.3, 1.4, 1.5_

- [ ] 7. 統合とテスト
- [ ] 7.1 APIルーターの統合
  - annotation_apiルーターをメインアプリに登録
  - CORS設定の確認
  - _Requirements: 7.3, 7.4_
- [ ] 7.2 ユニットテスト
  - 認証サービスのテスト（正常認証・認証失敗）
  - トークン検証テスト（有効・無効・期限切れ）
  - アノテーション保存テスト（新規・上書き・バリデーションエラー）
  - 元気度値バリデーションテスト
  - CSVエクスポートテスト
  - _Requirements: 1.1, 1.2, 4.4, 4.5, 7.5, 9.3, 9.4, 9.5, 9.6_
- [ ] 7.3 統合テスト
  - ログインフロー全体テスト
  - 一覧取得・フィルタリングテスト
  - アノテーション保存→一覧反映テスト
  - ページネーション動作テスト
  - CSVエクスポートテスト
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 3.1, 3.2, 3.3, 3.4, 3.5, 4.4, 9.1_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1 (アノテーター認証) | 2.3, 4.1, 6.1, 6.5, 7.2, 7.3 |
| 2 (桜一覧表示) | 3.1, 3.2, 4.2, 6.2, 7.3 |
| 3 (一覧フィルタリング) | 3.1, 4.2, 6.2, 7.3 |
| 4 (アノテーション入力) | 3.3, 3.4, 4.2, 4.3, 6.3, 7.2, 7.3 |
| 5 (撮影情報表示) | 3.3, 6.3 |
| 6 (アノテーションナビゲーション) | 4.2, 6.4 |
| 7 (データベース設計) | 1.1, 1.2, 1.3, 2.1, 2.2, 7.1, 7.2 |
| 8 (S3画像連携) | 5.1 |
| 9 (CSVエクスポート) | 3.5, 4.2, 6.2, 7.2, 7.3 |
