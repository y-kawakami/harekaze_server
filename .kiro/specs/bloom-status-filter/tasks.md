# Implementation Plan

## Tasks

- [ ] 1. BloomStateService の実装
- [ ] 1.1 (P) 都道府県別オフセット値の計算機能を実装する
  - CSV ファイル（260121_bloom_state.csv）から都道府県ごとの開花状態開始日を読み込む
  - ヘッダー行（1-2行目）と例示行（3行目）をスキップして4行目以降を処理する
  - 各都道府県について、開花→3分咲き、開花→5分咲き、散り始め→花＋若葉、散り始め→葉のみの日数差をオフセット値として計算する
  - 日付形式「M月D日」をパースし、年度は撮影日から推定する
  - 沖縄県（全フィールドが「-」）など、データがない都道府県では None を返す
  - CSVパースエラー時は警告ログを出力して該当行をスキップする
  - _Requirements: 1.2, 1.3, 1.13_

- [ ] 1.2 開花状態判定ロジックを実装する
  - 8段階のステータス定義（before_bloom, blooming, 30_percent, 50_percent, full_bloom, falling, with_leaves, leaves_only）を作成する
  - FloweringDateService から開花予想日、満開開始予想日、満開終了予想日を取得する
  - 撮影日と開花予想日、満開予想日、都道府県別オフセットを組み合わせて8段階のステータスを判定する
  - 開花予想日または満開開始予想日が取得できない場合は None を返す
  - シングルトンパターン（get_bloom_state_service）でインスタンスを管理する
  - _Requirements: 1.1, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10, 1.11, 1.12_

- [ ] 2. データベーススキーマ拡張
- [ ] 2.1 (P) EntireTree モデルに bloom_status カラムを追加する
  - VARCHAR(20)、NULL 許容のカラムを追加する
  - Mapped型アノテーションを使用して定義する
  - _Requirements: 2.1, 2.2_

- [ ] 2.2 Alembic マイグレーションを作成する
  - bloom_status カラムの追加とインデックス作成を含むマイグレーションファイルを生成する
  - アップグレード時にカラム追加とインデックス作成、ダウングレード時にインデックス削除とカラム削除を実装する
  - _Requirements: 2.3_

- [ ] 3. バッチ更新スクリプトの実装
- [ ] 3.1 既存レコードの bloom_status 一括更新スクリプトを作成する
  - 全 EntireTree レコードを取得し、BloomStateService で開花状態を計算してカラムを更新する
  - ドライランモード（--dry-run）で実際の更新を行わずに計算結果のみ表示する機能を実装する
  - バッチサイズ指定（--batch-size）でメモリ効率を考慮した処理を行う
  - 処理の進捗（処理済み件数、更新件数、スキップ件数）を標準出力に表示する
  - エラー発生時はログに詳細を出力し、処理を継続する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 4. アノテーション API の拡張
- [ ] 4.1 (P) 一覧取得 API に bloom_status フィルタリング機能を追加する
  - クエリパラメータで bloom_status を受け取り、カンマ区切りで複数指定可能にする
  - フィルター条件に bloom_status を追加してクエリを絞り込む
  - レスポンスの各アイテムに bloom_status フィールドを含める
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 4.2 (P) 一覧取得 API に開花状態別統計情報を追加する
  - 各開花状態ごとの総件数、準備完了件数、アノテーション完了件数を集計する
  - BloomStatusStats スキーマを作成してレスポンスに含める
  - _Requirements: 4.4_

- [ ] 4.3 詳細取得 API のナビゲーションを bloom_status フィルター対応にする
  - 詳細画面で bloom_status フィルターが適用されている場合、同じフィルター条件内で前後移動を行う
  - フィルターパラメータを受け取り、annotation_detail のロジックを拡張する
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 5. フロントエンド一覧画面の拡張
- [ ] 5.1 (P) 開花状態フィルター UI を実装する
  - 開花状態選択用のドロップダウンまたはチップを追加する
  - 複数選択可能にして、URL パラメータ（bloom_status）と同期させる
  - フィルター選択時に API リクエストを発行して一覧を更新する
  - _Requirements: 6.1, 6.2_

- [ ] 5.2 (P) 開花状態別統計情報の表示を実装する
  - 各開花状態ごとの総件数、準備完了件数、アノテーション完了件数を表示する
  - API から取得した bloom_status_stats を適切にフォーマットして表示する
  - _Requirements: 6.3_

- [ ] 5.3 (P) 画像サムネイルに開花状態バッジを表示する
  - 各画像サムネイルに bloom_status に応じたバッジまたはラベルを追加する
  - bloom_status が NULL の場合は「未設定」として表示する
  - DB値（英語キー）を日本語ラベルに変換して表示する
  - _Requirements: 6.4, 6.5_

- [ ] 6. フロントエンド詳細画面の改善
- [ ] 6.1 開花状態表示の色分けを強化する
  - 8段階の開花状態に対応したスタイル（getBloomStatusStyle）を実装する
  - 開花前=グレー、開花〜満開=ピンク系グラデーション、散り始め=オレンジ、花＋若葉/葉のみ=緑系の色分けを適用する
  - バッジまたはラベルとして目立つ位置に表示する
  - _Requirements: 7.1, 7.2_

- [ ] 7. 統合テスト
- [ ] 7.1 BloomStateService の単体テストを作成する
  - 8段階ステータス判定ロジックの各境界条件をテストする
  - NULL ケース（開花予想日なし、都道府県データなし）をテストする
  - CSV パースエラー時の挙動をテストする
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10, 1.11, 1.12, 1.13_

- [ ] 7.2 API フィルタリングの結合テストを作成する
  - bloom_status パラメータによる絞り込みが正しく動作することを確認する
  - 統計情報（bloom_status 別件数）の正確性を確認する
  - ナビゲーション（bloom_status フィルター適用時の前後移動）を確認する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 1.2, 7.1 |
| 1.2 | 1.1, 7.1 |
| 1.3 | 1.1, 7.1 |
| 1.4 | 1.2, 7.1 |
| 1.5 | 1.2, 7.1 |
| 1.6 | 1.2, 7.1 |
| 1.7 | 1.2, 7.1 |
| 1.8 | 1.2, 7.1 |
| 1.9 | 1.2, 7.1 |
| 1.10 | 1.2, 7.1 |
| 1.11 | 1.2, 7.1 |
| 1.12 | 1.2, 7.1 |
| 1.13 | 1.1, 7.1 |
| 2.1 | 2.1 |
| 2.2 | 2.1 |
| 2.3 | 2.2 |
| 3.1 | 3.1 |
| 3.2 | 3.1 |
| 3.3 | 3.1 |
| 3.4 | 3.1 |
| 3.5 | 3.1 |
| 4.1 | 4.1, 7.2 |
| 4.2 | 4.1, 7.2 |
| 4.3 | 4.1, 7.2 |
| 4.4 | 4.2, 7.2 |
| 5.1 | 4.3, 7.2 |
| 5.2 | 4.3, 7.2 |
| 5.3 | 4.3, 7.2 |
| 6.1 | 5.1 |
| 6.2 | 5.1 |
| 6.3 | 5.2 |
| 6.4 | 5.3 |
| 6.5 | 5.3 |
| 7.1 | 6.1 |
| 7.2 | 6.1 |
