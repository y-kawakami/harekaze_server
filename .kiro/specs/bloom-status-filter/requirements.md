# Requirements Document

## Project Description (Input)
すでに実装した元気度アノテーションツールに開花状態のステータスごとの表示とフィルタを行いたい。

ステータスは以下です。
- 開花前
- 開花
- 3分咲き
- 5分咲き
- 8分咲き（満開）
- 散り始め
- 花＋若葉（葉桜）
- 葉のみ

すでに各木の元気度入力画面では表示だけは一部対応しています。
これらのステータスは、
master/flowering_date.csv,
master/260121_bloom_state.csv と、各木の開花予想日、満開開始予想日、満開終了予定日をもとに決められます。

開花前、8分咲き、散り始めは flowing_date.csv と撮影日、撮影場所から判定可能。
(EntireTree の photo_date, Tree の location)

開花前: 開花予想日より前
8分咲き: 満開開始予想日
散り始め: 満開終了予想日

しかし、flowing_date.csv には 3分咲き、5分咲きなどの他のステータスはないので、
260121_bloom_state.csv から推定する必要がある。
ただし、260121_bloom_state.csv は各都道府県の代表地点なので、

開花開始日、満開開始日、満開終了日を起点として3分咲き開始日、5分咲き開始日、花＋若葉開始日、葉のみが＋何日かを決めて、
その+X日を適用する。

例えば、青森県青森市の場合撮影日と表示の関係は以下となります。

4月17日〜4月18日: 開花
4月19日: 3分咲き
4月20日〜4月21日: 5分咲き
4月22日〜4月26日: 満開
4月27日〜5月1日: 散り始め
5月2日〜5月6日: 花＋若葉
5月7日〜: 葉のみ

これに対応して青森県の他の地点では各ステータス間の間隔を見てステータスを決定します。

開花日〜開花日+1日まで
開花開花日+2日まで: 3分咲き
開花日+3日〜満開開始予想日: 5分咲き
満開開始予想日〜満開終了予想日-1日:  満開
満開終了予想日〜満開終了予想日+4日: 散り始め
満開終了予想日+4日〜満開終了予想日+8日: 花＋若葉
満開終了予想日+9日〜: 葉のみ

このようにステータスを決定するのですが、アノテーションツールでソート・フィルタを行いたいので、
EntireTree にステータスのカラムを追加してインデックスを追加したい。
まずそれを行うスクリプトが必要になります。

また、アノテーションツールを更新し、各ステータスのフィルタと、一覧ページで各ステータスのアノテーション準備完了枚数と、
アノテーション入力完了枚数を表示したい。

## Introduction

本機能は、桜の元気度アノテーションツールに開花状態（bloom status）のフィルタリング・表示機能を追加するものです。開花状態は撮影日と撮影場所の開花予想データをもとに計算され、8つのステータス（開花前、開花、3分咲き、5分咲き、8分咲き（満開）、散り始め、花＋若葉（葉桜）、葉のみ）に分類されます。

この機能により、アノテーターは特定の開花状態の画像のみを効率的に選別・作業できるようになり、アノテーション作業の品質と効率が向上します。

## Requirements

### Requirement 1: 開花状態計算ロジックの改善

**Objective:** データ管理者として、正確な開花状態の計算ロジックを使いたい。それにより各地点・撮影日に対して一貫性のある開花状態を判定できる。

#### Acceptance Criteria

1. The 開花状態判定サービス shall 以下の8つのステータスを定義する: 開花前、開花、3分咲き、5分咲き、8分咲き（満開）、散り始め、花＋若葉（葉桜）、葉のみ。

2. The 開花状態判定サービス shall `master/260121_bloom_state.csv`を読み込み、各都道府県の代表地点における各ステータスの開始日を保持する。

3. The 開花状態判定サービス shall 各都道府県について、代表地点のデータから以下のオフセット値を計算する:
   - 開花→3分咲きオフセット: 3分咲き開始日 - 開花開始日
   - 開花→5分咲きオフセット: 5分咲き開始日 - 開花開始日
   - 散り始め→花＋若葉オフセット: 花＋若葉開始日 - 散り始め開始日
   - 散り始め→葉のみオフセット: 葉のみ開始日 - 散り始め開始日

4. When 撮影日が開花予想日より前である場合, the 開花状態判定サービス shall 「開花前」を返す。

5. When 撮影日が開花予想日から（開花予想日+都道府県別3分咲きオフセット-1日）の範囲である場合, the 開花状態判定サービス shall 「開花」を返す。

6. When 撮影日が（開花予想日+都道府県別3分咲きオフセット）から（開花予想日+都道府県別5分咲きオフセット-1日）の範囲である場合, the 開花状態判定サービス shall 「3分咲き」を返す。

7. When 撮影日が（開花予想日+都道府県別5分咲きオフセット）から（満開開始予想日-1日）の範囲である場合, the 開花状態判定サービス shall 「5分咲き」を返す。

8. When 撮影日が満開開始予想日から（満開終了予想日-1日）の範囲である場合, the 開花状態判定サービス shall 「8分咲き（満開）」を返す。

9. When 撮影日が満開終了予想日から（満開終了予想日+都道府県別花＋若葉オフセット-1日）の範囲である場合, the 開花状態判定サービス shall 「散り始め」を返す。

10. When 撮影日が（満開終了予想日+都道府県別花＋若葉オフセット）から（満開終了予想日+都道府県別葉のみオフセット-1日）の範囲である場合, the 開花状態判定サービス shall 「花＋若葉（葉桜）」を返す。

11. When 撮影日が（満開終了予想日+都道府県別葉のみオフセット）以降である場合, the 開花状態判定サービス shall 「葉のみ」を返す。

12. If 開花予想日・満開開始予想日のいずれかが取得できない場合, the 開花状態判定サービス shall NULLを返す。

13. If 撮影場所の都道府県が`260121_bloom_state.csv`に存在しない場合（例: 沖縄県）, the 開花状態判定サービス shall NULLを返す。

### Requirement 2: データベーススキーマ拡張

**Objective:** データベース管理者として、EntireTreeテーブルに開花状態カラムを追加したい。それによりフィルタリング・ソートのパフォーマンスを確保できる。

#### Acceptance Criteria

1. The EntireTreeモデル shall bloom_statusカラム（VARCHAR(20)、NULL許容、インデックス付き）を持つ。

2. The bloom_statusカラム shall 以下の値のみを許容する: 開花前、開花、3分咲き、5分咲き、8分咲き（満開）、散り始め、花＋若葉（葉桜）、葉のみ、NULL。

3. The Alembicマイグレーション shall bloom_statusカラムの追加とインデックス作成を含む。

### Requirement 3: 開花状態バッチ更新スクリプト

**Objective:** 運用担当者として、既存の全EntireTreeレコードに対して開花状態を一括計算・更新するスクリプトを実行したい。それにより、既存データに開花状態を反映できる。

#### Acceptance Criteria

1. The バッチ更新スクリプト shall 全てのEntireTreeレコードを取得し、各レコードに対して開花状態を計算してbloom_statusカラムを更新する。

2. The バッチ更新スクリプト shall 処理の進捗を標準出力に表示する（処理済み件数、更新件数、スキップ件数）。

3. The バッチ更新スクリプト shall ドライランモード（--dry-run）をサポートし、実際の更新を行わずに計算結果のみを表示する。

4. The バッチ更新スクリプト shall バッチサイズ指定（--batch-size）をサポートし、メモリ効率を考慮した処理を行う。

5. If スクリプト実行中にエラーが発生した場合, the バッチ更新スクリプト shall エラー詳細をログに出力し、処理を継続する。

### Requirement 4: アノテーションAPI拡張

**Objective:** アノテーターとして、開花状態でフィルタリングして画像一覧を取得したい。それにより特定の開花状態の画像に集中して作業できる。

#### Acceptance Criteria

1. When bloom_statusパラメータが指定された場合, the アノテーションAPI shall 指定された開花状態の画像のみを返す。

2. The アノテーションAPI shall bloom_statusパラメータで複数の開花状態を指定できる（カンマ区切りまたは配列）。

3. The 一覧レスポンス shall 各アイテムにbloom_statusフィールドを含む。

4. The 一覧レスポンス shall 統計情報として各開花状態ごとの総件数、準備完了件数、アノテーション完了件数を含む。

### Requirement 5: アノテーション詳細画面の改善

**Objective:** アノテーターとして、詳細画面で正確な開花状態を確認したい。それにより画像の季節的文脈を把握しながらアノテーションできる。

#### Acceptance Criteria

1. The 詳細レスポンス shall bloom_statusフィールドを含む（既存機能の改善）。

2. The bloom_statusフィールド shall Requirement 1で定義した計算ロジックに基づく正確な値を返す。

3. When bloom_statusフィルターが適用されている場合, the 詳細画面のナビゲーション shall 同じフィルター条件内での前後移動を行う。

### Requirement 6: フロントエンド一覧画面の拡張

**Objective:** アノテーターとして、一覧画面で開花状態ごとのフィルターと統計を確認したい。それにより作業対象の選択と進捗確認が効率化する。

#### Acceptance Criteria

1. The 一覧画面 shall 開花状態フィルターのドロップダウンまたはチップを表示する。

2. When 開花状態フィルターが選択された場合, the 一覧画面 shall 選択されたステータスの画像のみを表示する。

3. The 一覧画面 shall 各開花状態ごとの統計情報（総件数、準備完了件数、アノテーション完了件数）を表示する。

4. The 一覧画面の各画像サムネイル shall 開花状態のバッジまたはラベルを表示する。

5. While 開花状態がNULLの画像が存在する場合, the 一覧画面 shall 「不明」または「未設定」として表示する。

### Requirement 7: フロントエンド詳細画面の改善

**Objective:** アノテーターとして、詳細画面で開花状態を視認しやすい形式で確認したい。それにより迅速に画像の季節的文脈を把握できる。

#### Acceptance Criteria

1. The 詳細画面 shall 開花状態をバッジまたはラベルとして目立つ位置に表示する。

2. The 開花状態表示 shall ステータスに応じた色分け（例: 開花前=グレー、満開=ピンク、葉のみ=緑）を行う。
