Web アプリの API サーバを python で実装したい。

## 機能

- セッション管理(ログイン)
    - 明示的なユーザサインアップ・ログインは不要
    - 複数のAPIの呼び出しが同じユーザ(セッション)により行われたかどうかを識別したい
    - 認証用 cookie の発行を行う.
- 桜の写真の登録
    - 桜の木全体の写真と、投稿者名を登録
    - 写真の位置と写真をアップロードして、画像解析を行い、桜に関する情報を返す。同時にその桜の情報を DB に登録し、他のユーザからも参照できるようにする。
    - 画像解析の結果は以下が得られる
        - 元気度: 1.0-5.0の連続値と、その値を四捨五入した値(1,2,3,4,5)。内部的には連続値で保持するが、ユーザへの表示用には四捨五入した値を使用する。
- 桜に追加情報を登録するために、追加の写真を登録することができる。
    - 幹の寄りの写真
        - 画像解析から幹の模様(1~5の数値。1:滑らか~5:ガサガサ)・樹齢を推定することができる。
        - 350ml缶と一緒に撮影すると、幹の周を推定することができる。
    - 幹の穴の写真
        - 穴があった場合は報告のため写真を登録できる
    - テングス病
        - 病変があった場合は、報告のため写真を登録できる
    - キノコの写真
        - キノコに寄生されている場合は、報告のため写真を登録できる
- 全ユーザから投稿された桜の情報の検索
    - 緯度・経度と半径を指定し、該当する桜の一覧を取得
    - フィルタとして元気度の範囲、樹齢の範囲、状態(幹の穴の有無、テングス病の有無、キノコの有無を)を指定できる
- ユーザから投稿された桜の本数の取得
    - 都道府県, もしくは自治体(市区町村)を指定できる
    - フィルタとして元気度の範囲、樹齢の範囲、状態(幹の穴の有無、テングス病の有無、キノコの有無を)を指定できる
- ユーザから投稿された桜の集計情報の取得
    - 都道府県, もしくは自治体(市区町村)を指定できる
    - 各元気度の分布(元気度1,2,3,4,5であった桜の本数)
    - 樹齢の分布(~20年の本数, 30~39年の本数, 40~49年の本数, 50~59年の本数, 60年~の本数)


## API

### API リスト

#### POST /api/auth/session

セッション管理用の cookie を set-cookie レスポンスヘッダで返す


#### POST /api/tree/entire

桜の木全体の写真を登録する。
画像解析を行い、元気度を返す。
また、同時にその桜の情報を DB に登録する。
(現時点では、画像解析を行い元気度を返すモデルはモックで良い)
また、画像は高画質なもの(1080x1920)が送られてくるので、(540x960)にリサイズしたサムネイルも作成しておく。
また、緯度、経度は近傍検索しやすいように緯度、経度のカラムに加えて MySQL のGEOMETRY 型のカラムも追加しておく。

- リクエストパラメータ
    - 桜の画像
    - 緯度・経度
    - 投稿者名
- レスポンス(200: 正常時)
    - tree id
        - 登録した桜に付与されるID.
        - 追加の写真登録に必要.
    - tree number
        - 表示用の番号 (ユーザに対して「#23493」というふうに表示に使われる)
    - 元気度
        - 1~5の整数値
    - 撮影場所
        - 文字列
    - 撮影日時
        - iso8601
- レスポンス(400: エラー時)
    - 木が映っていない(エラーコード: 101)

#### POST /api/tree/{tree_id}/decorated

桜の木全体の写真に、診断結果(元気度)に基づき情報を付与して装飾した写真を送信する。

- パスパラメータ
    - tree_id: POST /api/tree/entire で返された tree id
- リクエストパラメータ
    - 情報を付与した写真
- レスポンス(200: 正常時)
    - resopnse body なし。ステータスコードのみ.
- レスポンス(400: エラー時)
    - tree_id が存在しない(エラーコード: 100)

#### POST /api/tree/{tree_id}/stem

幹の寄りの写真を登録する。
- 画像解析から樹齢を推定することができる。
- 350ml缶と一緒に撮影すると、幹の周を推定することができる。
(現時点では、画像解析を行い結果を返すモデルはモックで良い)

- パスパラメータ
    - tree_id: POST /api/tree/entire で返された tree id
- リクエストパラメータ
    - 幹の寄りの写真
    - 緯度・経度
- レスポンス(200: 正常時)
    - 幹の模様(1~5の値。1:滑らか~5:ガサガサ)
    - 350ml缶の検出の有無
    - 幹周(350ml缶の検出ができた場合のみ)
    - 樹齢
- レスポンス(400: エラー時)
    - tree_id が存在しない(エラーコード: 100)
    - 幹が検出できない(エラーコード: 102)

#### POST /api/tree/{tree_id}/hole

穴の写真を登録する。

- パスパラメータ
    - tree_id: POST /api/tree/entire で返された tree id
- リクエストパラメータ
    - 幹の穴の写真
    - 緯度・経度
- レスポンス(200: 正常時)
    - resopnse body なし。ステータスコードのみ.
- レスポンス(400: エラー時)
    - tree_id が存在しない(エラーコード: 100)

#### POST /api/tree/{tree_id}/tengusu

テングス病の写真を登録する。

- パスパラメータ
    - tree_id: POST /api/tree/entire で返された tree id
- リクエストパラメータ
    - テングス病の写真
    - 緯度・経度
- レスポンス(200: 正常時)
    - resopnse body なし。ステータスコードのみ.
- レスポンス(400: エラー時)
    - tree_id が存在しない(エラーコード: 100)

#### POST /api/tree/{tree_id}/mushroom

キノコの写真を登録する。

- パスパラメータ
    - tree_id: POST /api/tree/entire で返された tree id
- リクエストパラメータ
    - テングス病の写真
    - 緯度・経度
- レスポンス(200: 正常時)
    - resopnse body なし。ステータスコードのみ.
- レスポンス(400: エラー時)
    - tree_id が存在しない(エラーコード: 100)


#### GET /api/tree/search

全ユーザから投稿された桜の情報の検索を行う。
緯度・経度、半径は geohash

- リクエストパラメータ(Query parameter)
    - 緯度
    - 経度
    - 半径
    - フィルタ条件(各項目オプション)
        - 元気度の範囲: 1-5
        - 樹齢の範囲: 整数値の下限~上限
        - 幹の穴の有無
        - テングス病の有無
        - キノコの有無
    - ページング情報
        - ページ数
        - ページごとの件数
- レスポンス(200: 正常時)
    - ヒット件数
    - 各木の情報(配列)
        - tree id
        - tree number
        - 投稿者
        - サムネイル

#### GET /api/tree/{tree_id}

各木の詳細情報を取得する

- パスパラメータ
    - tree_id: POST /api/tree/entire で返された tree id
- レスポンス(200: 正常時)
    - tree id
    - tree number
    - 撮影緯度・経度
    - 撮影場所(文字列)
    - 投稿者
    - 撮影日時(iso8601)
    - 木全体の写真(URL)
    - 元気度
    - 幹の寄りの写真が登録されている場合
        - 幹の寄りの写真(URL)
        - 幹周
        - 樹齢
    - 幹の穴の写真が登録されている場合
        - 幹の穴の写真のURL
    - テングス病の写真が登録されている場合
        - テングス病の写真のURL
    - キノコの写真が登録されている場合
        - キノコの写真のURL

### GET /api/tree/count

ユーザから投稿された桜の本数の取得を取得する。

- リクエストパラメータ
  - 都道府県
  - 自治体名(市区町村)
     - 都道府県もしくは自治体名のいずれかは指定が必要
  - フィルタパラメータ
    - 元気度の範囲
    - 樹齢の範囲
    - 状態(幹の穴の有無、テングス病の有無、キノコの有無)
- レスポンス(200: 正常時)
  - 桜の本数

### GET /api/tree/stats

ユーザから投稿された桜の集計情報を取得する

- リクエストパラメータ
  - 都道府県
  - 自治体名(市区町村)
     - 都道府県もしくは自治体名のいずれかは指定が必要
  - フィルタパラメータ
    - 元気度の範囲
    - 樹齢の範囲
    - 状態(幹の穴の有無、テングス病の有無、キノコの有無)
- レスポンス(200: 正常時)
  - 各元気度の分布(元気度1,2,3,4,5であった桜の本数)
  - 樹齢の分布(~20年の本数, 30~39年の本数, 40~49年の本数, 50~59年の本数, 60年~の本数)

### GET /api/info/flowering_date

桜の開花日に関する情報を取得する

- リクエストパラメータ
  - 緯度
  - 経度
- レスポンス
    - 緯度軽度に対応する住所
    - 開花予想日 (YYYY-MM-dd)
    - 満開予想日 (YYYY-MM-dd)




### API共通: リクエスト・レスポンスの形式

- POST, PUTリクエストの　request body は JSON
  - 画像の送信を伴うものは multipart-form-data
- レスポンスの　response body は　JSON
  - エラー時にもエラーコードが含まれる JSON を返す。
    - e.g. { "error": 100, "reason": "樹木が検出できません" }


## DB テーブル一覧

MySQLのテーブル構成です。　

### User

ユーザ(セッション)情報

- id: uuid
- ip_addr
  - IP Address
- created_at
- updated_at

### Tree

木の情報

- id: uuid
- user_id
  - User テーブルの対応するレコードのID
- tree_number: string
- latitude
- longitude
- position
  - GEOMETRY 型
- image_obj_key
  - s3 に保存した全体画像の object id
- thumb_obj_key
  - s3 に保存した全体画像のサムネイルの object id
- decorated_image_obj_key
  - s3 に保存した装飾した写真の object id
- vitality
  - 元気度
- created_at
- updated_at

### Stem

幹の情報

- id: uuid
- user_id
  - User テーブルの対応するレコードのID
- tree_id: uuid
  - Tree テーブルの対応するレコードのID
- latitude
- longitude
- image_obj_key
  - s3 に保存した幹の画像の object id
- thumb_obj_key
  - s3 に保存した幹の画像のサムネイルの object id
- can_detected
  - 幹の写真中の缶の有無
- circumference
  - 幹周(cm)
- texture
  - 幹の模様: 1:滑らか~5:ガサガサ
- created_at
- updated_at

### StemHole

幹の穴の情報

- id: uuid
- user_id
  - User テーブルの対応するレコードのID
- tree_id: uuid
  - Tree テーブルの対応するレコードのID
- latitude
- longitude
- image_obj_key
  - s3 に保存した穴の画像の object id
- thumb_obj_key
  - s3 に保存した穴の画像のサムネイルの object id
- created_at
- updated_at

### Tengus

テングス病の情報

- id: uuid
- user_id
  - User テーブルの対応するレコードのID
- tree_id: uuid
  - Tree テーブルの対応するレコードのID
- latitude
- longitude
- image_obj_key
  - s3 に保存したテングス病の画像の object id
- thumb_obj_key
  - s3 に保存したテングス病の画像のサムネイルの object id
- created_at
- updated_at

### Mushroom

キノコの情報

- id: uuid
- user_id
  - User テーブルの対応するレコードのID
- tree_id: uuid
  - Tree テーブルの対応するレコードのID
- latitude
- longitude
- image_obj_key
  - s3 に保存したテングス病の画像の object id
- thumb_obj_key
  - s3 に保存したテングス病の画像のサムネイルの object id
- created_at
- updated_at



## 設計方針

- ドメイン、アプリケーション、インフラ、入出力のレイヤーに分かれていること
    - クリーンアーキテクチャを参考にするのがよいが、煩雑になる場合は厳密でなくてもよい
    - DBアクセスの機能は repository としてインフラ層として独立していてほしい


## 使用するライブラリ

実装には以下のライブラリを利用してください。

- fastapi
    - Web Server の実装
- SQLArchemy
    - RDB アクセス
- Alembic
    - マイグレーションの管理・実行


## 注意

画像解析のモデルは別途実装するので、
現状はモック実装としてください。
それ以外は完全な実装を行なってください。